import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
  console.log('üå± Seeding database (UA/EN)‚Ä¶');

  // ---------------------------
  // Achievements (idempotent)
  // ---------------------------
  const achievements = await Promise.all([
    prisma.achievement.upsert({
      where: { code: 'FIRST_ORDER' },
      update: {
        title: '–ü–µ—Ä—à–∏–π –∑–∞–∫–∞–∑ / First order',
        description: '–û—Ñ–æ—Ä–º–∏–ª–∏ –ø–µ—Ä—à—É –∑–∞—è–≤–∫—É –≤ AutoAssist+ / First service request in AutoAssist+',
        icon: 'üéâ',
        points: 50,
        isActive: true,
      },
      create: {
        code: 'FIRST_ORDER',
        title: '–ü–µ—Ä—à–∏–π –∑–∞–∫–∞–∑ / First order',
        description: '–û—Ñ–æ—Ä–º–∏–ª–∏ –ø–µ—Ä—à—É –∑–∞—è–≤–∫—É –≤ AutoAssist+ / First service request in AutoAssist+',
        icon: 'üéâ',
        points: 50,
      },
    }),
    prisma.achievement.upsert({
      where: { code: 'LOYAL_CUSTOMER' },
      update: {
        title: '–õ–æ—è–ª—å–Ω–∏–π –∫–ª—ñ—î–Ω—Ç / Loyal customer',
        description: '5+ –∑–∞—è–≤–æ–∫ –∑–∞ —Ä—ñ–∫ / 5+ orders in a year',
        icon: '‚≠ê',
        points: 200,
        isActive: true,
      },
      create: {
        code: 'LOYAL_CUSTOMER',
        title: '–õ–æ—è–ª—å–Ω–∏–π –∫–ª—ñ—î–Ω—Ç / Loyal customer',
        description: '5+ –∑–∞—è–≤–æ–∫ –∑–∞ —Ä—ñ–∫ / 5+ orders in a year',
        icon: '‚≠ê',
        points: 200,
      },
    }),
    prisma.achievement.upsert({
      where: { code: 'NO_ACCIDENTS_1Y' },
      update: {
        title: '–†—ñ–∫ –±–µ–∑ –î–¢–ü / 1 year no accidents',
        description: '–ê–∫—É—Ä–∞—Ç–Ω–∞ —ó–∑–¥–∞ –ø—Ä–æ—Ç—è–≥–æ–º —Ä–æ–∫—É / Careful driving for a year',
        icon: 'üõ°Ô∏è',
        points: 300,
        isActive: true,
      },
      create: {
        code: 'NO_ACCIDENTS_1Y',
        title: '–†—ñ–∫ –±–µ–∑ –î–¢–ü / 1 year no accidents',
        description: '–ê–∫—É—Ä–∞—Ç–Ω–∞ —ó–∑–¥–∞ –ø—Ä–æ—Ç—è–≥–æ–º —Ä–æ–∫—É / Careful driving for a year',
        icon: 'üõ°Ô∏è',
        points: 300,
      },
    }),
    prisma.achievement.upsert({
      where: { code: 'TIMELY_MAINTENANCE' },
      update: {
        title: '–¢–û –≤—á–∞—Å–Ω–æ / Timely maintenance',
        description: '3 –¢–û –ø—ñ–¥—Ä—è–¥ —É —Å—Ç—Ä–æ–∫ / 3 consecutive on-time services',
        icon: 'üîß',
        points: 150,
        isActive: true,
      },
      create: {
        code: 'TIMELY_MAINTENANCE',
        title: '–¢–û –≤—á–∞—Å–Ω–æ / Timely maintenance',
        description: '3 –¢–û –ø—ñ–¥—Ä—è–¥ —É —Å—Ç—Ä–æ–∫ / 3 consecutive on-time services',
        icon: 'üîß',
        points: 150,
      },
    }),
  ]);

  console.log(`‚úÖ Achievements upserted: ${achievements.length}`);

  // ---------------------------
  // Calc Profiles (admin pricing)
  // ---------------------------
  await Promise.all([
    prisma.calcProfile.upsert({
      where: { code: 'ECONOMY' },
      update: { name: 'Economy', partsCoeff: 0.9, laborCoeff: 0.9, laborRate: 380, active: true },
      create: { code: 'ECONOMY', name: 'Economy', partsCoeff: 0.9, laborCoeff: 0.9, laborRate: 380, active: true },
    }),
    prisma.calcProfile.upsert({
      where: { code: 'STANDARD' },
      update: { name: 'Standard', partsCoeff: 1.0, laborCoeff: 1.0, laborRate: 400, active: true },
      create: { code: 'STANDARD', name: 'Standard', partsCoeff: 1.0, laborCoeff: 1.0, laborRate: 400, active: true },
    }),
    prisma.calcProfile.upsert({
      where: { code: 'PREMIUM' },
      update: { name: 'Premium', partsCoeff: 1.15, laborCoeff: 1.15, laborRate: 450, active: true },
      create: { code: 'PREMIUM', name: 'Premium', partsCoeff: 1.15, laborCoeff: 1.15, laborRate: 450, active: true },
    }),
  ]);

  // ---------------------------
  // Service Centers (geo demo)
  // ---------------------------
  await Promise.all([
    prisma.serviceCenter.upsert({
      where: { id: 1 },
      update: { name: 'AutoAssist Kyiv Center', lat: 50.4501, lng: 30.5234, city: 'Kyiv', address: 'Khreshchatyk 1' },
      create: { name: 'AutoAssist Kyiv Center', lat: 50.4501, lng: 30.5234, city: 'Kyiv', address: 'Khreshchatyk 1' },
    }),
    prisma.serviceCenter.upsert({
      where: { id: 2 },
      update: { name: 'AutoAssist Left Bank', lat: 50.4509, lng: 30.63, city: 'Kyiv', address: 'Left Bank Ave 10' },
      create: { name: 'AutoAssist Left Bank', lat: 50.4509, lng: 30.63, city: 'Kyiv', address: 'Left Bank Ave 10' },
    }),
  ]);

  // ---------------------------
  // Client (unique by phone)
  // ---------------------------
  const client = await prisma.client.upsert({
    where: { phone: '+380501234567' },
    update: {
      name: '–Ü–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ / Ivan Petrov',
      email: 'ivan@example.com',
      loyaltyPoints: 150,
    },
    create: {
      name: '–Ü–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ / Ivan Petrov',
      phone: '+380501234567',
      email: 'ivan@example.com',
      loyaltyPoints: 150,
      rating: 4.8,
    },
  });

  // ---------------------------
  // Demo User linked to Client (for notifications/login)
  // ---------------------------
  const user = await prisma.user.upsert({
    where: { phone: client.phone! },
    update: { clientId: client.id, name: client.name, email: client.email ?? undefined },
    create: {
      clientId: client.id,
      name: client.name,
      email: client.email,
      phone: client.phone,
      passwordHash: '', // wallet-based or external auth in demo
      role: 'customer',
    },
  });

  // ---------------------------
  // Vehicle (unique by plate)
  // ---------------------------
  const vehicle = await prisma.vehicle.upsert({
    where: { plate: 'AA1234BB' },
    update: {
      clientId: client.id,
      vin: 'WBAPH5C58BE123456',
      make: 'BMW',
      model: 'X5',
      year: 2020,
      mileage: 45000,
    },
    create: {
      clientId: client.id,
      plate: 'AA1234BB',
      vin: 'WBAPH5C58BE123456',
      make: 'BMW',
      model: 'X5',
      year: 2020,
      mileage: 45000,
    },
  });

  // ---------------------------
  // Order (NEW -> with location + timeline)
  // ---------------------------
  const order = await prisma.order.create({
    data: {
      clientId: client.id,
      vehicleId: vehicle.id,
      category: 'engine', // engine, transmission, suspension, electrical, etc.
      description:
        '–î–≤–∏–≥—É–Ω –Ω–µ –∑–∞–≤–æ–¥–∏—Ç—å—Å—è, –ø—ñ–¥–æ–∑—Ä–∞ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ—Ä / Engine won‚Äôt start, suspected starter',
      channel: 'web', // web, mobile
      priority: 'normal', // low, normal, high, urgent
      locations: {
        create: [
          {
            kind: 'pickup',
            lat: 50.4501,
            lng: 30.5234,
            address: '–ö–∏—ó–≤, –≤—É–ª. –•—Ä–µ—â–∞—Ç–∏–∫, 1 / Kyiv, Khreshchatyk St, 1',
            notes: '–ö–ª—ñ—î–Ω—Ç —á–µ–∫–∞—Ç–∏–º–µ –ø–æ—Ä—É—á / Customer will wait nearby',
          },
        ],
      },
      timeline: {
        create: [
          {
            event: 'order_created',
            details: { source: 'seed', channel: 'web', locale: 'uk/en' },
          },
        ],
      },
    },
  });

  // ---------------------------
  // Notifications preferences + sample notification
  // ---------------------------
  await prisma.notificationPreference.upsert({
    where: { userId: user.id },
    update: { enabledChannels: ['IN_APP'], enabledTypes: [] },
    create: { userId: user.id, enabledChannels: ['IN_APP'], enabledTypes: [] },
  });
  await prisma.notification.create({
    data: {
      userId: user.id,
      type: 'ORDER_CREATED',
      title: '–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞',
      message: `–ó–∞—è–≤–∫–∞ #${order.id} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞`,
      priority: 'MEDIUM',
      orderId: order.id,
      metadata: { seed: true },
      channels: ['IN_APP'],
      action: { label: '–û—Ç–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É', url: `/orders/${order.id}` } as any,
      status: 'SENT',
    },
  });

  // ---------------------------
  // Estimate (QUOTE)
  // ---------------------------
  await prisma.estimate.create({
    data: {
      orderId: order.id,
      itemsJson: {
        parts: [
          { name: '–°—Ç–∞—Ä—Ç–µ—Ä / Starter', partNo: 'BMW-12345', price: 8500, quantity: 1 },
          { name: '–©—ñ—Ç–∫–∏ —Å—Ç–∞—Ä—Ç–µ—Ä–∞ / Starter brushes', partNo: 'BMW-67890', price: 350, quantity: 1 },
        ],
      },
      laborJson: {
        tasks: [
          { name: '–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ / Diagnostics', hours: 1, rate: 800 },
          { name: '–ó–∞–º—ñ–Ω–∞ —Å—Ç–∞—Ä—Ç–µ—Ä–∞ / Starter replacement', hours: 2, rate: 800 },
        ],
      },
      total: 11250,
      currency: 'UAH',
      validUntil: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // +7 days
      approved: false,
    },
  });

  // ---------------------------
  // Insurance offer (rule-based, simple)
  // Note: –º–æ–¥–µ–ª—å InsuranceOffer —É —Å—Ö–µ–º—ñ –º–∞—î: orderId, code, title, description, price, duration?, coverage?, status?, validUntil?, etc.
  // ---------------------------
  await prisma.insuranceOffer.create({
    data: {
      orderId: order.id,
      code: 'BREAKDOWN_EXTENDED',
      title: '–†–æ–∑—à–∏—Ä–µ–Ω–∏–π –∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ –ø–æ–ª–æ–º–æ–∫ / Extended breakdown cover',
      description:
        '–ü–æ–∫—Ä–∏—Ç—Ç—è —Ä–µ–º–æ–Ω—Ç—É –¥–≤–∏–≥—É–Ω–∞ —ñ —Ç—Ä–∞–Ω—Å–º—ñ—Å—ñ—ó –Ω–∞ 12 –º—ñ—Å—è—Ü—ñ–≤ / Engine & transmission repairs for 12 months',
      price: 2500,
      duration: 12, // months
      coverage: {
        engine: true,
        transmission: true,
        electrical: false,
        suspension: false,
      },
      status: 'OFFERED',
      validUntil: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // +30 days
    },
  });

  // ---------------------------
  // Optional: add a maintenance record (to demo history)
  // ---------------------------
  await prisma.maintenanceRecord.create({
    data: {
      vehicleId: vehicle.id,
      type: 'inspection',
      description: '–ü–µ—Ä–≤–∏–Ω–Ω–∏–π –æ–≥–ª—è–¥ / Initial inspection',
      mileage: 45000,
      cost: 0,
      performedAt: new Date(),
      performedBy: 'AutoAssist+ Service',
    },
  });

  console.log('‚úÖ Seed completed.');
  console.log(`üìã Order ID: ${order.id}`);
  console.log(`üë§ Client: ${client.name} (${client.phone})`);
  console.log(`üë§ User ID: ${user.id}`);
  console.log(`üöó Vehicle: ${vehicle.make} ${vehicle.model} (${vehicle.plate})`);
}

main()
  .catch((e) => {
    console.error('‚ùå Seeding failed:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
